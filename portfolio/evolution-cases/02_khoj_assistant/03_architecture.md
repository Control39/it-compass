# ๐๏ธ 03_architecture.md - ะััะธัะตะบัััะฐ Khoj

## ๐ ะะฑัะฐั ะฐััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    KHOJ - ะะตััะพะฝะฐะปัะฝัะน ะะ-ะฐััะธััะตะฝั        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
          โโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโ
          โ                   โ                   โ
โโโโโโโโโโโผโโโโโโโโโโ โโโโโโโโโโโผโโโโโโโโโโ โโโโโโโผโโโโโโโโ
โ   DATA LAYER      โ โ  BUSINESS LOGIC   โ โ  UI LAYER   โ
โ  (ััะฐะฝะธะปะธัะต)      โ โ  (ะพะฑัะฐะฑะพัะบะฐ)      โ โ  (ะธะฝัะตััะตะนั)โ
โโโโโโโโโโโฌโโโโโโโโโโ โโโโโโโโโโโฌโโโโโโโโโโ โโโโโโโฌโโโโโโโโ
          โ                   โ                   โ
          โโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโ
                              โ
                      โโโโโโโโโผโโโโโโโโโ
                      โ  INTEGRATION   โ
                      โ  (ัะฐััะธัะตะฝะธั)  โ
                      โโโโโโโโโโโโโโโโโโ
```

## ๐งฉ ะะธะบัะพัะตัะฒะธัะฝะฐั ะฐััะธัะตะบัััะฐ

### 1. database (PostgreSQL + pgvector)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะฅัะฐะฝะตะฝะธะต ะธ ะธะฝะดะตะบัะฐัะธั ะฒะตะบัะพัะฝัั ะฟัะตะดััะฐะฒะปะตะฝะธะน ัะตะบััะฐ

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**
- **ะะฑัะฐะท:** `docker.io/pgvector/pgvector:pg15`
- **ะกะตัั:** ะกัะฐัะธัะตัะบะธะน IP `172.20.0.10` ะฒ ัะตัะธ `khoj_network`
- **ะฅัะฐะฝะธะปะธัะต:** ะขะพะผ `khoj_db` ะดะปั ะฟะพััะพัะฝะฝะพะณะพ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั
- **ะะตะทะพะฟะฐัะฝะพััั:** ะฃัะตัะฝัะต ะดะฐะฝะฝัะต ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั (POSTGRES_USER, POSTGRES_PASSWORD)
- **Healthcheck:** ะัะพะฒะตัะบะฐ ะณะพัะพะฒะฝะพััะธ ั ะฟะพะผะพััั `pg_isready`

**ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั:**
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต pgvector ะดะปั ะฒะตะบัะพัะฝะพะณะพ ะฟะพะธัะบะฐ ะฟะพ ัะผััะปั
- ะัะดะตะปะตะฝะธะต ะฒ ะพัะดะตะปัะฝัะน ัะตัะฒะธั ะดะปั ะฝะตะทะฐะฒะธัะธะผะพะณะพ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั
- ะะพััะพัะฝะฝะพะต ััะฐะฝะธะปะธัะต ะดะปั ะทะฐัะธัั ะพั ะฟะพัะตัะธ ะดะฐะฝะฝัั

### 2. sandbox (Terrarium)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะทะพะปะธัะพะฒะฐะฝะฝะฐั ััะตะดะฐ ะฒัะฟะพะปะฝะตะฝะธั ะบะพะดะฐ

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**
- **ะะฑัะฐะท:** `ghcr.io/khoj-ai/terrarium:latest`
- **ะกะตัั:** ะะพะดะบะปััะตะฝะธะต ะบ `khoj_network`
- **ะะตะทะพะฟะฐัะฝะพััั:** ะะพะปะฝะฐั ะธะทะพะปััะธั ะพั ะพัะฝะพะฒะฝะพะน ัะธััะตะผั
- **Healthcheck:** ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ัะตัะตะท HTTP-ะทะฐะฟัะพั

**ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั:**
- ะะฑะตัะฟะตัะตะฝะธะต ะฑะตะทะพะฟะฐัะฝะพััะธ ะฟัะธ ะฒัะฟะพะปะฝะตะฝะธะธ ะบะพะดะฐ ะะ
- ะะพะทะผะพะถะฝะพััั ะฒัะฟะพะปะฝะตะฝะธั Python-ัะบัะธะฟัะพะฒ ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะน ััะตะดะต
- ะะฝัะตะณัะฐัะธั ั ะพัะฝะพะฒะฝัะผ ัะตัะฒะธัะพะผ ัะตัะตะท API

### 3. search (SearXNG)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะพะธัะบะพะฒัะน ะดะฒะธะถะพะบ ะดะปั ะฐะณัะตะณะฐัะธะธ ัะตะทัะปััะฐัะพะฒ

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**
- **ะะฑัะฐะท:** `docker.io/searxng/searxng:latest`
- **ะกะตัั:** ะะพะดะบะปััะตะฝะธะต ะบ `khoj_network`
- **ะฅัะฐะฝะธะปะธัะต:** ะขะพะผ `khoj_search` ะดะปั ะบะพะฝัะธะณััะฐัะธะธ
- **ะะฝัะตะณัะฐัะธั:** ะะฐัััะพะนะบะฐ ัะตัะตะท ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั `SEARXNG_BASE_URL`

**ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั:**
- ะะณัะตะณะฐัะธั ัะตะทัะปััะฐัะพะฒ ะธะท ัะฐะทะปะธัะฝัั ะฟะพะธัะบะพะฒัั ัะธััะตะผ
- ะัะธะฒะฐัะฝัะน ะฟะพะธัะบ ะฑะตะท ะพััะปะตะถะธะฒะฐะฝะธั
- ะะฝัะตะณัะฐัะธั ั ะพัะฝะพะฒะฝัะผ ัะตัะฒะธัะพะผ ะดะปั ัะฐััะธัะตะฝะธั ะฒะพะทะผะพะถะฝะพััะตะน ะฟะพะธัะบะฐ

### 4. khoj (ะัะฝะพะฒะฝะพะน ัะตัะฒะธั)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะฏะดัะพ ัะธััะตะผั ะธ ะฒะตะฑ-ะธะฝัะตััะตะนั

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**
- **ะะฑัะฐะท:** `ghcr.io/khoj-ai/khoj:2.0.0-beta.22`
- **ะะพััั:** ะัะพะฑัะพั ะฟะพััะฐ 42110 ะฝะฐ ัะพัั
- **ะะฐะฒะธัะธะผะพััะธ:** ะะฐะฒะธัะธั ะพั database, search ะธ sandbox
- **ะฅัะฐะฝะธะปะธัะต:** ะขะพะผ `khoj_data` ะดะปั ะบะพะฝัะตะฝัะฐ ะธ ัะพะผ `./local/models` ะดะปั ะผะพะดะตะปะตะน
- **ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**
  - `KHOJ_ADMIN_PASSWORD`: ะะฐัะพะปั ะฐะดะผะธะฝะธัััะฐัะพัะฐ
  - `KHOJ_DJANGO_SECRET_KEY`: ะกะตะบัะตัะฝัะน ะบะปัั ะฑะตะทะพะฟะฐัะฝะพััะธ
  - `KHOJ_DB_*`: ะะฐัะฐะผะตััั ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
  - `KHOJ_DEBUG`: ะะตะถะธะผ ะพัะปะฐะดะบะธ (ะพัะบะปััะตะฝ)
  - `KHOJ_TELEMETRY`: ะขะตะปะตะผะตััะธั (ะฒะบะปััะตะฝะฐ)

**ะััะธัะตะบัััะฝัะต ัะตัะตะฝะธั:**
- ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะตะน ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต extra_hosts ะดะปั ัะตัะตะฝะธั ะฟัะพะฑะปะตะผ ั ัะตััั ะฒ Windows/WSL2
- Healthcheck-ะทะฐะฒะธัะธะผะพััะธ ะผะตะถะดั ัะตัะฒะธัะฐะผะธ
- Entry point ั ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธะตะผ ะฟะพััะพะฒ ัะตัะตะท socat

## ๐ ะกะตัะตะฒะฐั ะฐััะธัะตะบัััะฐ

### Docker ัะตัั

```yaml
networks:
  khoj_network:
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะัะดะตะปะตะฝะฝะฐั ะฟะพะดัะตัั `172.20.0.0/16` ะดะปั ะธะทะพะปััะธะธ ัะตัะฒะธัะพะฒ
- ะกัะฐัะธัะตัะบะธะน IP `172.20.0.10` ะดะปั ะฑะฐะทั ะดะฐะฝะฝัั
- ะัะต ัะตัะฒะธัั ะฟะพะดะบะปััะตะฝั ะบ ะพะดะฝะพะน ัะตัะธ ะดะปั ะฒะฝัััะตะฝะฝะตะณะพ ะฒะทะฐะธะผะพะดะตะนััะฒะธั
- ะะตัะตะฝะธะต ะฟัะพะฑะปะตะผั ั Windows/WSL2 ัะตัะตะท `extra_hosts`

### ะัะพะฑะปะตะผะฐ Windows/WSL2

**ะัะพะฑะปะตะผะฐ:** ะ Windows ั WSL2 ะฒะพะทะฝะธะบะฐัั ะฟัะพะฑะปะตะผั ั ะดะพัััะฟะพะผ ะบ ะบะพะฝัะตะนะฝะตัะฐะผ ะฑะฐะทั ะดะฐะฝะฝัั ัะตัะตะท localhost.

**ะะตัะตะฝะธะต:** ะัะฟะพะปัะทะพะฒะฐะฝะธะต `extra_hosts` ะดะปั ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธั localhost ะฝะฐ IP ะฑะฐะทั ะดะฐะฝะฝัั:

```yaml
extra_hosts:
  - "localhost:172.20.0.10"
```

## ๐ ะะฐะฒะธัะธะผะพััะธ ะผะตะถะดั ัะตัะฒะธัะฐะผะธ

```yaml
depends_on:
  database:
    condition: service_healthy
  search:
    condition: service_started
  sandbox:
    condition: service_healthy
```

**ะกััะฐัะตะณะธั ะทะฐะฟััะบะฐ:**
1. ะกะฝะฐัะฐะปะฐ ะทะฐะฟััะบะฐะตััั ะธ ะฟัะพะฒะตััะตััั ะฑะฐะทะฐ ะดะฐะฝะฝัั
2. ะะฐัะตะผ ะทะฐะฟััะบะฐะตััั ะฟะพะธัะบะพะฒัะน ัะตัะฒะธั
3. ะะฐัะตะผ ะทะฐะฟััะบะฐะตััั ะธ ะฟัะพะฒะตััะตััั sandbox
4. ะขะพะปัะบะพ ะฟะพัะปะต ััะพะณะพ ะทะฐะฟััะบะฐะตััั ะพัะฝะพะฒะฝะพะน ัะตัะฒะธั Khoj

## ๐พ ะฃะฟัะฐะฒะปะตะฝะธะต ะดะฐะฝะฝัะผะธ

### ะขะพะผะฐ (Volumes)

| ะขะพะผ | ะะฐะทะฝะฐัะตะฝะธะต | ะฅะพัั-ะฟััั |
|------|------------|-----------|
| khoj_db | ะะฐะฝะฝัะต PostgreSQL | /var/lib/postgresql/data |
| khoj_search | ะะพะฝัะธะณััะฐัะธั SearXNG | /etc/searxng |
| khoj_data | ะะพะฝัะตะฝั Khoj | /app/khoj/content |
| ./local/models | ะะพะบะฐะปัะฝัะต ะผะพะดะตะปะธ ะะ | ./local/models |

**ะกััะฐัะตะณะธั ััะฐะฝะตะฝะธั:**
- ะัะต ะฒะฐะถะฝัะต ะดะฐะฝะฝัะต ััะฐะฝัััั ะฒ ะธะผะตะฝะพะฒะฐะฝะฝัั ัะพะผะฐั Docker
- ะะพะฝัะธะณััะฐัะธั ะฟะพะธัะบะพะฒะธะบะฐ ัะพััะฐะฝัะตััั ะดะปั ะฟะพััะพัะฝััะฒะฐ ะฝะฐัััะพะตะบ
- ะะพะฝัะตะฝั ะฟะพะปัะทะพะฒะฐัะตะปั ัะพััะฐะฝัะตััั ะผะตะถะดั ะฟะตัะตะทะฐะฟััะบะฐะผะธ
- ะะพะดะดะตัะถะบะฐ ะปะพะบะฐะปัะฝัั ะผะพะดะตะปะตะน ะะ ะดะปั ะฐะฒัะพะฝะพะผะฝะพะน ัะฐะฑะพัั

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะััะตะฝัะธัะธะบะฐัะธั ะธ ะฐะฒัะพัะธะทะฐัะธั
- **ะะดะผะธะฝ-ะฟะฐะฝะตะปั:** ะะฐัะธัะตะฝะฐ ะฟะฐัะพะปะตะผ (KHOJ_ADMIN_PASSWORD)
- **API:** ะัะฟะพะปัะทัะตั ัะตะบัะตัะฝัะน ะบะปัั Django (KHOJ_DJANGO_SECRET_KEY)
- **ะะฐะทะฐ ะดะฐะฝะฝัั:** ะัะดะตะปัะฝัะต ััะตัะฝัะต ะดะฐะฝะฝัะต ั ะพะณัะฐะฝะธัะตะฝะฝัะผะธ ะฟัะฐะฒะฐะผะธ

### ะะทะพะปััะธั
- **Sandbox:** ะะพะปะฝะฐั ะธะทะพะปััะธั ะฒัะฟะพะปะฝะตะฝะธั ะบะพะดะฐ
- **ะกะตัั:** ะะทะพะปะธัะพะฒะฐะฝะฝะฐั Docker-ัะตัั ะดะปั ะฒะฝัััะตะฝะฝะตะณะพ ะฒะทะฐะธะผะพะดะตะนััะฒะธั
- **ะะพะฝัะตะนะฝะตัั:** ะะฐะถะดัะน ัะตัะฒะธั ะฒ ะพัะดะตะปัะฝะพะผ ะบะพะฝัะตะนะฝะตัะต ะฟะพ ะฟัะธะฝัะธะฟั ะธะทะพะปััะธะธ

### ะะพะฝัะธะณััะฐัะธั
- **ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:** ะัะต ััะฒััะฒะธัะตะปัะฝัะต ะดะฐะฝะฝัะต ะฟะตัะตะดะฐัััั ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- **ะะตะทะตัะฒะฝะฐั ะบะพะฝัะธะณััะฐัะธั:** ะะฐะปะธัะธะต backup-ัะฐะนะปะฐ ะฝะฐ ัะปััะฐะน ะฟัะพะฑะปะตะผ

## ๐ ะะฐัััะฐะฑะธััะตะผะพััั ะธ ัะฐััะธััะตะผะพััั

### ะขะตะบััะฐั ะผะฐัััะฐะฑะธััะตะผะพััั
- **ะะพัะธะทะพะฝัะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต:** ะะณัะฐะฝะธัะตะฝะพ (ะฝะต ะฟัะตะดััะผะพััะตะฝะพ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะพัะดะตะปัะฝัั ัะตัะฒะธัะพะฒ)
- **ะะตััะธะบะฐะปัะฝะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต:** ะะพะทะผะพะถะฝะฐ ะฝะฐัััะพะนะบะฐ ัะตััััะพะฒ ะดะปั ะบะฐะถะดะพะณะพ ะบะพะฝัะตะนะฝะตัะฐ
- **ะะฐะณััะทะบะฐ:** ะััะธัะตะบัััะฐ ะฟะพะดัะพะดะธั ะดะปั ะฟะตััะพะฝะฐะปัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะพะทะผะพะถะฝะพััะธ ัะฐััะธัะตะฝะธั
- **ะะฝัะตะณัะฐัะธั ั ะฒะฝะตัะฝะธะผะธ ะธััะพัะฝะธะบะฐะผะธ:** ะะพะดะดะตัะถะบะฐ ะธะฝะดะตะบัะฐัะธะธ ะดะพะบัะผะตะฝัะพะฒ, email, ัะพะพะฑัะตะฝะธะน
- **ะะพะดะดะตัะถะบะฐ ัะฐะทะปะธัะฝัั ะผะพะดะตะปะตะน ะะ:** ะงะตัะตะท ะดะธัะตะบัะพัะธั `local/models`
- **API ะดะปั ะฒะฝะตัะฝะธั ะธะฝัะตะณัะฐัะธะน:** ะะพะทะผะพะถะฝะพััั ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ะธะฝัะตะณัะฐัะธะน
- **ะะฝะพะณะพะฟะพะปัะทะพะฒะฐัะตะปััะบะฐั ะฒะตััะธั:** ะััะธัะตะบัััะฐ ะฟะพะทะฒะพะปัะตั ะดะพะฑะฐะฒะธัั ะฐััะตะฝัะธัะธะบะฐัะธั ะธ ะธะทะพะปััะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

## ๐ ะะธะทะฝะตะฝะฝัะน ัะธะบะป ัะตัะฒะธัะพะฒ

```
ะะฐะฟััะบ ัะธััะตะผั
    โ
    โผ
ะะฐะฟััะบ ัะตัะธ khoj_network
    โ
    โผ
ะะฐะฟััะบ database โ ะัะพะฒะตัะบะฐ healthcheck
    โ
    โผ
ะะฐะฟััะบ search โ ะัะพะฒะตัะบะฐ ะทะฐะฟััะบะฐ
    โ
    โผ
ะะฐะฟััะบ sandbox โ ะัะพะฒะตัะบะฐ healthcheck
    โ
    โผ
ะะฐะฟััะบ khoj โ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
    โ
    โผ
ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
```

*ะััะธัะตะบัััะฐ ะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะฐ: 28.01.2026*